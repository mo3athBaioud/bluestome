var cookie_name=(_qs_args.cookie_name)?_qs_args.cookie_name:"tags_ac";var cookie_max=(_qs_args.cookie_max)?_qs_args.cookie_max:2;var cookie_str_max=(_qs_args.cookie_str_max)?_qs_args.cookie_str_max:3000;function TagCompleter(_1){if(TagCompleter.cache[_1]){return TagCompleter.cache[_1];}this.user_id=_1;this.tags=[];this.tagsLoaded=false;this.tagsLoading=false;this.delayedCallback=null;this.delayedQuery=null;TagCompleter.cache[_1]=this;}TagCompleter.cache={};TagCompleter.prototype.startLoading=function(){if(this.tagsLoaded||this.tagsLoading){return;}var _2=cookie_name+"1";var c=_get_cookie(_2);writeAPIDebug("getting "+_2+":"+c);if(c!=null&&_qs_args.no_cookie!=1){if(_qs_args.eval_cookie==1){try{for(var i=0;i<cookie_max;i++){var _2=cookie_name+(i+1);var c2=_get_cookie(_2);if(c2!=null){c+=c2;}}this.evalThisIntoTags(""+c+"");}catch(e){var t="";for(t in e){t+=t+":"+e[t]+" ";}writeDebug(t);}this.markAsLoaded();}else{var _7={cookies:[]};for(var i=0;i<cookie_max;i++){_7.cookies.push(cookie_name+(i+1));}F.fragment_getter.get("/get_cookie.gne",_7,this,"get_cookie_onLoad");}}else{this.tagsLoading=true;F.API.callMethod("flickr.tags.getListUser",{user_id:this.user_id,include_raw:1},this);}};TagCompleter.prototype.evalThisIntoTags=function(_8){_8=_8.replace(",","\",\"");_8=_8.replace("[","[\"");_8=_8.replace("]","\"]");_8=_8.replace("&#44;",",");_8=_8.replace("\\","");this.tags=eval(_8);};TagCompleter.prototype.get_cookie_onLoad=function(_9,_10,_11){this.tags=[];if(!_9){return;}this.evalThisIntoTags(_10);this.markAsLoaded();};TagCompleter.prototype.flickr_tags_getListUser_onLoad=function(_12,_13,_14,_15){this.tags=[];if(!_12){return;}var _16=_13.getElementsByTagName("raw");for(var i=0,node;node=_16[i];i++){this.tags[i]=node.firstChild.data;}this.markAsLoaded();if(this.tags.length){this.stickTagsInCookie();}};TagCompleter.prototype.stickTagsInCookie=function(){for(var i=0;i<cookie_max;i++){var _17=cookie_name+(i+1);if(_get_cookie(_17)!=null){writeDebug("clearing cookie "+_17+":"+_get_cookie(_17));_delete_cookie(_17);}}var A=[];for(var i=0,tag;tag=this.tags[i];i++){A.push(escape_utf8(tag.replace(",","&#44;")));}var str=JSON.stringify(A);str=str.replace("\"","");writeAPIDebug("stickTagsInCookie():"+str);var _20=cookie_max*cookie_str_max;if(str.length>_20){var s=_20-1;var p=str.lastIndexOf(",",s);str=str.slice(0,p)+"]";}var _23=[];while(str.length>cookie_str_max){_23.unshift(str.slice(-cookie_str_max));str=str.slice(0,-cookie_str_max);}_23.unshift(str);for(var i=0,s;s=_23[i];i++){var _17=cookie_name+(i+1);writeAPIDebug(_17+"("+s.length+"):"+s);_set_cookie(_17,s,0);}};TagCompleter.prototype.markAsLoaded=function(){this.tagsLoaded=true;this.tagsLoading=false;if(this.delayedCallback){this.autocomplete(this.delayedQuery,this.delayedCallback);this.delayedCallback=null;}};TagCompleter.prototype.autocomplete=function(_24,_25){_24=this.sanitiseQuery(_24);if(!_24){_25([]);return;}if(!this.tagsLoaded){this.delayedQuery=_24;this.delayedCallback=_25;if(!this.tagsLoading){this.startLoading();}_25([]);return;}var _26=[];var _27=new RegExp("^"+_24+".*","i");for(var i=0,tag;tag=this.tags[i];i++){var _28=this.sanitiseQuery(tag);if(_28.match(_27)){_26[_26.length]=tag;}}_25(_26);};TagCompleter.prototype.sanitiseQuery=function(_29){return _29.replace(/[^\w]/ig,"");};function TagCompleteWidget(_30,_31,_32){this.input=_30;_30.autocomplete="off";this.element=_31;this.completer=new TagCompleter(_32);this.blockSubmit=false;this.clearList();_30.onkeypress=_hitch(this,"keypress");_30.onkeydown=_hitch(this,"keydown");_30.onkeyup=_hitch(this,"complete");_30.onfocus=_hitch(this,"kickitoff");_30.onblur=_hitch(this,"autoHideList");this.no_auto_hide=0;}TagCompleteWidget.prototype.suppressAutoHiding=function(){this.no_auto_hide=1;};TagCompleteWidget.prototype.autoHideList=function(e){if(this.no_auto_hide){this.no_auto_hide=0;}else{this.hide_tim=setTimeout("_ge('"+this.element.id+"').style.display = 'none';",50);}};TagCompleteWidget.prototype.kickitoff=function(e){this.completer.startLoading();};TagCompleteWidget.prototype.complete=function(e){this.blockSubmit=false;var _34=_get_event_keycode(e);switch(_34){case _keys.DOWNARROW:case _keys.UPARROW:this.blockSubmit=false;return false;}var _35=this.input.value;var _36;if(_35.replace(/[^"]/g,"").length%2==1){_36=_35.split("\"");}else{_36=_35.split(" ");}var _37=_36[_36.length-1];this.completer.autocomplete(_37,_hitch(this,"showList"));};TagCompleteWidget.prototype.keypress=function(e){var _38=_get_event_keycode(e);if(this.shownTags.length>0||this.blockSubmit){switch(_38){case _keys.TAB:case _keys.ENTER:case _keys.DOWNARROW:case _keys.UPARROW:this.blockSubmit=false;return false;}}return true;};TagCompleteWidget.prototype.keydown=function(e){this.blockSubmit=false;var _39=_get_event_keycode(e);if(this.shownTags.length>0){switch(_39){case _keys.TAB:case _keys.ENTER:case _keys.RIGHTARROW:this.addTag(this.shownTags[this.selectedIndex]);this.blockSubmit=true;return false;case _keys.DOWNARROW:this.selectedIndex++;if(this.selectedIndex>=this.shownTags.length){this.selectedIndex=0;}this.doHighlight();return false;case _keys.UPARROW:this.selectedIndex--;if(this.selectedIndex<0){this.selectedIndex=this.shownTags.length-1;}this.doHighlight();return false;case _keys.ESCAPE:this.clearList();return false;}}return true;};TagCompleteWidget.prototype.doHighlight=function(){var _40=this.element.getElementsByTagName("span");var si=this.selectedIndex;var lsi=this.lastSelectedIndex;if(_40[si]){_40[si].className="selected";}if(lsi>-1&&lsi!=si&&_40[lsi]){_40[lsi].className="";}this.lastSelectedIndex=si;};TagCompleteWidget.prototype.showList=function(_43){if(this.hide_tim){clearTimeout(this.hide_tim);}this.selectedIndex=0;this.lastSelectedIndex=-1;this.shownTags=_43;this.element.innerHTML="";this.element.style.display=(_43.length>0)?"block":"none";for(var i=0,tag;tag=_43[i];i++){var _44=document.createElement("span");_44.index=i;_44.style.cursor="pointer";_44.appendChild(document.createTextNode(tag));var _45=this;_44.onmouseover=function(){_45.selectedIndex=this.index;_45.doHighlight();};_44.onmousedown=function(){_45.suppressAutoHiding();};_44.onclick=function(){_45.addTag(_45.shownTags[this.index]);};this.element.appendChild(_44);this.element.appendChild(document.createTextNode(" "));}this.doHighlight();};TagCompleteWidget.prototype.addTag=function(tag){if(/ /.test(tag)){tag="\""+tag+"\"";}if(/,/.test(tag)){tag="\""+tag+"\"";}var _47=this.input.value;var _48=_47.replace(/[^"]/g,"").length%2?"\"":" ";var _49=_47.split(_48);_49[_49.length-1]=tag;this.input.value=_49.join(_48)+" ";this.input.value=this.input.value.replace("\"\"","\"");this.clearList();this.input.focus();};TagCompleteWidget.prototype.clearList=function(){this.shownTags=[];this.selectedIndex=0;this.lastSelectedIndex=-1;while(this.element.hasChildNodes()){F.remove_el(this.element.firstChild,this.element);}this.element.style.display="none";};
